#!/usr/bin/env bash

set -e

readonly QUERENT="montchr"
readonly REPO_ID="montchr/dots"
readonly DOTFILES_ORIGIN="git@github.com:${REPO_ID}.git"
readonly DOTFILES_BRANCH="${CDOM_INIT_DOTFILES_BRANCH:-main}"
readonly DOTFILES_TARBALL_URL="https://github.com/${REPO_ID}/tarball/${DOTFILES_BRANCH}"
readonly DOTFILES_UTILS_BASE_URL="https://raw.githubusercontent.com/${REPO_ID}/${DOTFILES_BRANCH}/lib"

DOTFILES_DIR="${HOME}/.dots"


# ----------------------------------------------------------------------
# | Helper Functions                                                   |
# ----------------------------------------------------------------------

# Download file from a URL.
# Parameters:
#   URL
#   Output path
function download () {
  local url="$1"
  local output="$2"
  if command -v "curl" &>/dev/null; then
    curl -LsSo "$output" "$url" &>/dev/null
    return $?
  elif command -v "wget" &>/dev/null; then
    wget -qO "$output" "$url" &>/dev/null
    return $?
  fi
  return 1
}

# Source a file, falling back to sourcing ephemerally from the remote.
# Parameter:
#   Relative path to file
function source_ephemeral () {
  local path="$1"
  local tmp_file=""
  local url=""

  if [[ -f "${path}" ]]; then
    # shellcheck disable=SC1090
    . "${path}" \
      && return \
      || return 1
  fi

  tmp_file="$(mktemp /tmp/XXXXXXXX)"
  url="${DOTFILES_UTILS_BASE_URL}/${path}.sh"

  download "${url}" "${tmp_file}" && {
    # shellcheck disable=SC1090
    . "${tmp_file}" \
      && rm -rf "${tmp_file}"
  } && return 0

  return 1
}

function verify_os () {
  declare -r MINIMUM_MACOS_VERSION="10.10"
  # @TODO handle debian!
  declare -r MINIMUM_UBUNTU_VERSION="20.04"

  local os_name
  local os_version
  os_name="$(get_os)"
  os_version="$(get_os_version)"

  # Check if the OS is macOS and it's above the required version.
  if [ "$os_name" == "macos" ]; then
    if is_supported_version "$os_version" "$MINIMUM_MACOS_VERSION"; then
      return 0
    else
      printf "Sorry, this script is intended only for macOS %s+" "$MINIMUM_MACOS_VERSION"
    fi

    # Check if the OS is `Ubuntu` and it's above the required version.
  elif [ "$os_name" == "ubuntu" ]; then
    if is_supported_version "$os_version" "$MINIMUM_UBUNTU_VERSION"; then
      return 0
    else
      printf "Sorry, this script is intended only for Ubuntu %s+" "$MINIMUM_UBUNTU_VERSION"
    fi
  else
    printf "Sorry, this script is intended only for macOS and Ubuntu!"
  fi

  return 1
}

# Initialize dotfiles git repo in place.
# Globals:
#   DOTFILES_ORIGIN
function init_git_repo () {
  # @TODO set up branch tracking and submodules
  git init && git remote add origin "${DOTFILES_ORIGIN}"
}

# Run configuration script, if available.
# Globals:
#   CDOM_INIT_HOSTNAME
function .do_configure () {
  local hostname

  [[ -f os/$(get_os)/configure ]] \
    || print_warning "No configurator found for current OS '$(get_os)'! Continuing..." \
      && return

  if [[ -n "${CDOM_INIT_HOSTNAME}" ]]; then
    hostname="${CDOM_INIT_HOSTNAME}"
  else
    ask "Set the hostname: "
    hostname="$(get_answer)"
  fi

  # shellcheck disable=SC1090
  . "os/$(get_os)/configure" "${hostname:-CDOM}"
}

# ----------------------------------------------------------------------
# | Main                                                               |
# ----------------------------------------------------------------------

function main () {
  # Ensure that the following actions are made relative to this file's path.
  cd "$(dirname "${BASH_SOURCE[0]}")" ||
    exit 1

  # Ensure the OS is supported and above the minimum version.
  verify_os || exit 1

  if [[ "root" == $(whoami) ]]; then
    msg::warning "Running as root!"
  else
    ask_for_sudo
  fi

  source_ephemeral "utils"

  msg::hed "Who am I? Installing self..."

  source_ephemeral "world"

  if [[ ! -x "${XDG_CONFIG_HOME}/bootstrap" ]]; then
    msg::hed "Cloning dotfiles into ${XDG_CONFIG_HOME}"
    repo::sync "${XDG_CONFIG_HOME}" "gh" "${REPO_ID}"
  fi

  cd "${XDG_CONFIG_HOME}" || {
    print_error "We seem to be lost in '$(pwd)'. Something went wrong!"
    return 1
  }

  # @TODO ...


  # shellcheck disable=SC1090
  print_hed "OS Essentials" \
    && . "os/$(get_os)/install" \
    && print_result $? "OS Essentials"

  print_hed "OS Preferences" \
    && .do_configure \
    && print_result $? "OS Preferences"

  # Initialize the dotfiles directory as a git repo for a non-root user.
  if [[ "root" != $(whoami) ]] && ! is_git_repository; then
    print_hed "Initializing Dotfiles"
    execute \
      "init_git_repo" \
      "Initialize the Git repository"
  fi

  print_hed "Bootstrapping complete!"

  if ! is_ci; then
    print_hed "Restart"

    ask_for_confirmation "Do you want to restart? You probably should."
    printf "\n"

    if user_confirmed; then
      sudo shutdown -r now &> /dev/null
    fi
  fi
}

main "$@"
